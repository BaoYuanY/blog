---
title: 使用docker-compose管理gitlab
date: 2023-08-09 10:18:00
tags: [ 'Gitlab' ]
categories: [ 'Docker' , 'Gitlab' ]
excerpt: "使用docker-compose管理gitlab"
---

## 1. CentOS安装Docker
{% btn regular::Linux安装Docker::/linux-insert-docker::fa-solid fa-newspaper %}

## 2. Gitlab配置
下面是一个示例
```yaml
  gitlab:
    image: 'gitlab/gitlab-ee:16.0.1-ee.0'
    restart: 'no'
    hostname: 'gitlab.yangbaoyuan.cn'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.yangbaoyuan.cn'
      GITLAB_SKIP_UNMIGRATED_DATA_CHECK: 'true'
    ports:
      - '22:22'
      - '88:80'
      - '8443:443'
    container_name: gitlab
    volumes:
      - ./data/gitlab:/var/opt/gitlab/:rw
      - ./etc/gitlab:/etc/gitlab/:rw
      - ./log/gitlab:/var/log/gitlab/:rw
    shm_size: '2000m'
```

## 3. 用户配置
### 从日志获取
在 GitLab 的 Docker 镜像中，默认管理员的用户名是 `root`。要以管理员身份登录 GitLab，请按照以下步骤操作：

1. 打开 GitLab 的登录页面
2. 在登录页面中输入：
    - 用户名：root
    - 密码：在您首次安装 GitLab 时，系统会生成一个随机密码。在 Docker 容器启动时，您可以在日志中找到该密码。

若要查找在 Docker 容器启动时生成的密码，请按照以下步骤操作：

1. 首先，找到正在运行 GitLab 的 Docker 容器的 ID。在命令行中输入以下命令：

   ```
   docker ps
   ```

   找到试图运行 GitLab 的容器，然后记下 CONTAINER ID。

2. 使用此命令检查 GitLab 容器的日志：

   ```
   docker logs CONTAINER_ID
   ```

   使用刚刚记下的 CONTAINER ID 替换 `CONTAINER_ID`。

3. 在日志中，您应该能找到类似以下内容的行：

   ```
   ========================================================================
   You can configure the GitLab root password by setting the `GITLAB_ROOT_PASSWORD`
   The autogenerated root password is: THIS_IS_YOUR_PASSWORD
   ========================================================================
   ```
   使用您看到的生成的密码进行替换 `THIS_IS_YOUR_PASSWORD`。

使用该 `root` 用户和相应的密码登录。完成身份验证后，您就可以以管理员身份审核新用户和进行其他管理操作。

请注意，在您登录之后，强烈建议您更改默认的管理员密码，以确保系统安全。您可以通过 `root` 用户的用户设置页面完成此操作。

### 独立配置
如果您无法通过查看容器日志获取初始密码，可以尝试以下两种方法：(方法一适合docker直接运行，推荐方法二)

**方法一：设置 GitLab 的 root 密码**

1. 停止运行中的 GitLab 容器。

   ```
   docker stop CONTAINER_ID
   ```

   使用刚刚记下的 CONTAINER ID 替换 `CONTAINER_ID`。

2. 重新启动 GitLab 容器，这次将 `GITLAB_ROOT_PASSWORD` 设置为一个您喜欢的密码。

   ```bash
   docker run --detach \
     --hostname your-gitlab-domain.example.com \
     --publish 80:80 --publish 443:443 --publish 22:22 \
     --name gitlab \
     --restart always \
     --volume /srv/gitlab/config:/etc/gitlab \
     --volume /srv/gitlab/logs:/var/log/gitlab \
     --volume /srv/gitlab/data:/var/opt/gitlab \
     gitlab/gitlab-ce:latest \
     --env GITLAB_ROOT_PASSWORD=my-strong-password
   ```

   将 `your-gitlab-domain.example.com` 替换为您实际的 GitLab 域名，并将 `my-strong-password` 替换为您选择的新密码。

**方法二：进入 GitLab Docker 容器并手动重置密码**

1. 使用以下命令进入 GitLab 容器的 shell：

   ```bash
   docker exec -it CONTAINER_ID /bin/bash
   ```

   使用刚刚记下的 CONTAINER ID 替换 `CONTAINER_ID`。

2. 现在您位于容器内部，请运行以下命令以在 GitLab 控制台中设置新的 root 密码：

   ```bash
   gitlab-rails console
   ```

3. 控制台会加载，一旦加载完成，执行以下命令以设置新的 root 密码：

   ```ruby
   user = User.where(id: 1).first
   user.password = 'my-new-password'
   user.password_confirmation = 'my-new-password'
   user.save!
   ```

   将 `'my-new-password'` 替换为您选择的新密码。

4. 成功设置密码后，您可以使用 `root` 用户名和新设置的密码登录 GitLab。

无论选择哪种方法，请确保您已设置了一个安全且复杂的密码，以保护您的 GitLab 系统。登录后，您可以审核新用户注册或进行其他管理员操作。


